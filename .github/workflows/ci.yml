name: Terminal Setup CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
    
    - name: Run ShellCheck
      run: |
        echo "Running ShellCheck on all shell scripts..."
        shellcheck -S warning terminal-setup.sh terminal-core.sh terminal-utils.sh || true
        echo "ShellCheck completed"
    
    - name: Check Bash Syntax
      run: |
        echo "Checking bash syntax..."
        bash -n terminal-setup.sh
        bash -n terminal-core.sh
        bash -n terminal-utils.sh
        echo "Syntax check passed"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    strategy:
      matrix:
        ubuntu-version: ['20.04', '22.04']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl wget fontconfig
    
    - name: Make scripts executable
      run: chmod +x *.sh
    
    - name: Run test suite
      run: |
        chmod +x test.sh
        ./test.sh
    
    - name: Check VERSION file
      run: |
        if [ ! -f VERSION ]; then
          echo "VERSION file missing"
          exit 1
        fi
        version=$(cat VERSION)
        if [[ ! $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Invalid version format: $version"
          exit 1
        fi
        echo "Version: $version"
    
    - name: Verify module loading
      run: |
        # Global değişkenleri tanımla
        export LOG_FILE="/tmp/test.log"
        export BACKUP_DIR="/tmp/backup"
        export CONFIG_FILE="/tmp/config"
        export VERSION="3.1.0"
        export SCRIPT_DIR="$(pwd)"
        
        # Modülleri yükle
        source terminal-utils.sh
        source terminal-core.sh
        echo "Modules loaded successfully"

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl wget zsh fontconfig
    
    - name: Make scripts executable
      run: chmod +x *.sh
    
    - name: Test health check
      run: |
        ./terminal-setup.sh --health || true
    
    - name: Test dependency check
      run: |
        export LOG_FILE="/tmp/test.log"
        export BACKUP_DIR="/tmp/backup"
        export CONFIG_FILE="/tmp/config"
        export VERSION="3.1.0"
        export SCRIPT_DIR="$(pwd)"
        
        bash -c '
        source terminal-utils.sh
        source terminal-core.sh
        check_dependencies
        '
    
    - name: Test terminal detection
      run: |
        export LOG_FILE="/tmp/test.log"
        export BACKUP_DIR="/tmp/backup"
        
        bash -c '
        source terminal-utils.sh
        terminal=$(detect_terminal)
        echo "Detected terminal: $terminal"
        '

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check for hardcoded secrets
      run: |
        echo "Scanning for potential secrets..."
        if grep -r "password\s*=\s*" *.sh; then
          echo "Warning: Potential hardcoded password found"
        fi
        if grep -r "api_key\s*=\s*" *.sh; then
          echo "Warning: Potential hardcoded API key found"
        fi
        echo "Secret scan completed"
    
    - name: Check file permissions
      run: |
        echo "Checking file permissions..."
        for file in *.sh; do
          if [ -x "$file" ]; then
            echo "✓ $file is executable"
          else
            echo "✗ $file is not executable"
            exit 1
          fi
        done

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check README
      run: |
        if [ ! -f README.md ]; then
          echo "README.md missing"
          exit 1
        fi
        echo "README.md exists"
    
    - name: Check CHANGELOG
      run: |
        if [ ! -f CHANGELOG.md ]; then
          echo "⚠ CHANGELOG.md missing (optional)"
        else
          echo "✓ CHANGELOG.md exists"
        fi
    
    - name: Validate links in README
      run: |
        if grep -q "](http" README.md; then
          echo "✓ README contains links"
        fi

  release-check:
    name: Release Preparation Check
    runs-on: ubuntu-latest
    needs: [test, integration-test, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check VERSION matches tag
      run: |
        version=$(cat VERSION)
        echo "Current version: $version"
        
        # Check if this is a version bump commit
        if git log -1 --pretty=%B | grep -q "v$version"; then
          echo "Version commit detected"
        fi
    
    - name: Verify all required files
      run: |
        required_files=(
          "terminal-setup.sh"
          "terminal-core.sh"
          "terminal-utils.sh"
          "VERSION"
          "README.md"
          "LICENSE"
        )
        
        missing=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing+=("$file")
          fi
        done
        
        if [ ${#missing[@]} -ne 0 ]; then
          echo "Missing required files: ${missing[*]}"
          exit 1
        fi
        
        echo "All required files present"
    
    - name: Create summary
      run: |
        echo "## CI/CD Summary" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Lint checks passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Integration tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Security scan passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ All required files present" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Version: $(cat VERSION)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [lint, test, integration-test, security-scan]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "Pipeline completed"
        echo "Results:"
        echo "- Lint: ${{ needs.lint.result }}"
        echo "- Test: ${{ needs.test.result }}"
        echo "- Integration Test: ${{ needs.integration-test.result }}"
        echo "- Security Scan: ${{ needs.security-scan.result }}"