name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      
      - name: Run ShellCheck
        run: |
          echo "üîç Running ShellCheck..."
          ERRORS=0
          
          for script in *.sh; do
            echo "Checking $script..."
            if ! shellcheck -S warning "$script"; then
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "‚ö†Ô∏è ShellCheck found $ERRORS error(s) but continuing..."
          else
            echo "‚úÖ All scripts passed ShellCheck!"
          fi

  syntax-check:
    name: Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Bash syntax check
        run: |
          echo "üîç Checking Bash syntax..."
          ERRORS=0
          
          for script in *.sh; do
            echo "Checking $script..."
            if ! bash -n "$script"; then
              echo "‚ùå Syntax error in $script"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå Found $ERRORS syntax error(s)"
            exit 1
          else
            echo "‚úÖ All scripts have valid syntax!"
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [lint, syntax-check]
    
    strategy:
      matrix:
        ubuntu-version: ['20.04', '22.04']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Make scripts executable
        run: chmod +x *.sh
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget zsh
      
      - name: Run test suite (if exists)
        run: |
          if [ -f test.sh ]; then
            echo "üß™ Running tests on Ubuntu ${{ matrix.ubuntu-version }}..."
            ./test.sh || echo "‚ö†Ô∏è Tests failed but continuing"
          else
            echo "‚ÑπÔ∏è No test suite found, skipping..."
          fi

  version-check:
    name: Version Consistency Check
    runs-on: ubuntu-latest
    # Bu job ba≈üarƒ±sƒ±z olsa bile CI devam etsin
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check VERSION file exists
        run: |
          if [ ! -f VERSION ]; then
            echo "‚ö†Ô∏è VERSION file not found (will be created for release)"
          else
            VERSION=$(cat VERSION)
            echo "‚úÖ VERSION file found: $VERSION"
          fi
      
      - name: Check version consistency
        run: |
          echo "üîç Checking version consistency across files..."
          
          # Sadece VERSION dosyasƒ± varsa kontrol et
          if [ ! -f VERSION ]; then
            echo "‚ÑπÔ∏è VERSION file doesn't exist, skipping version check"
            exit 0
          fi
          
          FILE_VERSION=$(cat VERSION)
          echo "VERSION file: $FILE_VERSION"
          
          # Script versiyonlarƒ±nƒ± kontrol et
          if [ -f terminal-setup.sh ]; then
            SETUP_VERSION=$(grep '^VERSION=' terminal-setup.sh | cut -d'"' -f2 || echo "")
            echo "terminal-setup.sh: $SETUP_VERSION"
            
            if [ -n "$SETUP_VERSION" ] && [ "$SETUP_VERSION" != "$FILE_VERSION" ]; then
              echo "‚ö†Ô∏è Version mismatch in terminal-setup.sh"
            fi
          fi
          
          if [ -f install.sh ]; then
            INSTALL_VERSION=$(grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' install.sh | head -1 | sed 's/v//' || echo "")
            echo "install.sh: $INSTALL_VERSION"
            
            if [ -n "$INSTALL_VERSION" ] && [ "$INSTALL_VERSION" != "$FILE_VERSION" ]; then
              echo "‚ö†Ô∏è Version mismatch in install.sh"
            fi
          fi
          
          echo "‚ÑπÔ∏è Version check completed (warnings only, not blocking)"

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check required documentation
        run: |
          echo "üìÑ Checking documentation files..."
          
          MISSING=0
          
          # Required files
          [ -f README.md ] || { echo "‚ùå Missing: README.md"; MISSING=$((MISSING + 1)); }
          [ -f LICENSE ] || { echo "‚ùå Missing: LICENSE"; MISSING=$((MISSING + 1)); }
          
          # Recommended files
          [ -f CHANGELOG.md ] || echo "‚ö†Ô∏è Recommended: CHANGELOG.md"
          [ -f CONTRIBUTING.md ] || echo "‚ö†Ô∏è Recommended: CONTRIBUTING.md"
          [ -f SECURITY.md ] || echo "‚ö†Ô∏è Recommended: SECURITY.md"
          
          if [ $MISSING -gt 0 ]; then
            echo "‚ùå Missing $MISSING required file(s)"
            exit 1
          else
            echo "‚úÖ All required documentation present!"
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, syntax-check, test, documentation]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "üìä CI Summary:"
          echo "- Lint: ${{ needs.lint.result }}"
          echo "- Syntax Check: ${{ needs.syntax-check.result }}"
          echo "- Tests: ${{ needs.test.result }}"
          echo "- Documentation: ${{ needs.documentation.result }}"
          
          # Version check ba≈üarƒ±sƒ±z olsa bile CI ge√ßsin
          if [ "${{ needs.syntax-check.result }}" != "success" ] || \
             [ "${{ needs.documentation.result }}" != "success" ]; then
            echo "‚ùå CI Failed!"
            exit 1
          else
            echo "‚úÖ CI checks passed!"
          fi