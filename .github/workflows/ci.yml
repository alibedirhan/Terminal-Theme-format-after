name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 3.2.4)'
        required: true

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Make scripts executable
        run: |
          chmod +x *.sh
      
      - name: Run syntax check
        run: |
          bash -n terminal-setup.sh
          bash -n terminal-core.sh
          bash -n terminal-utils.sh
          bash -n terminal-ui.sh
          bash -n terminal-themes.sh
          bash -n terminal-assistant.sh
          bash -n install.sh
      
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      
      - name: Run ShellCheck
        run: |
          shellcheck -S warning terminal-setup.sh || true
          shellcheck -S warning terminal-core.sh || true
          shellcheck -S warning terminal-utils.sh || true
          shellcheck -S warning terminal-ui.sh || true
          shellcheck -S warning terminal-themes.sh || true
          shellcheck -S warning terminal-assistant.sh || true
          shellcheck -S warning install.sh || true
      
      - name: Run test suite
        run: ./test.sh

  validate-version:
    name: Validate Version Consistency
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check VERSION file
        run: |
          if [ ! -f VERSION ]; then
            echo "❌ VERSION file not found!"
            exit 1
          fi
          VERSION=$(cat VERSION)
          echo "VERSION file contains: $VERSION"
          
          # Extract version from tag
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          echo "Tag version: $TAG_VERSION"
          
          if [ "$VERSION" != "$TAG_VERSION" ]; then
            echo "❌ Version mismatch!"
            echo "VERSION file: $VERSION"
            echo "Git tag: $TAG_VERSION"
            exit 1
          fi
          echo "✅ Versions match!"
      
      - name: Check script versions
        run: |
          VERSION=$(cat VERSION)
          
          # Check terminal-setup.sh
          SETUP_VERSION=$(grep '^VERSION=' terminal-setup.sh | cut -d'"' -f2)
          if [ "$SETUP_VERSION" != "$VERSION" ]; then
            echo "❌ terminal-setup.sh version mismatch: $SETUP_VERSION != $VERSION"
            exit 1
          fi
          
          # Check install.sh
          INSTALL_VERSION=$(grep 'v[0-9]\+\.[0-9]\+\.[0-9]\+' install.sh | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          if [ "$INSTALL_VERSION" != "$VERSION" ]; then
            echo "❌ install.sh version mismatch: $INSTALL_VERSION != $VERSION"
            exit 1
          fi
          
          echo "✅ All versions are consistent!"

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, validate-version]
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Get version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Extract changelog for this version
          if [ -f CHANGELOG.md ]; then
            # Get content between version headers
            sed -n "/## \[${{ steps.version.outputs.version }}\]/,/## \[/p" CHANGELOG.md | sed '$d' > release-notes.md
            
            # If empty, use a default message
            if [ ! -s release-notes.md ]; then
              echo "### Changes in v${{ steps.version.outputs.version }}" > release-notes.md
              echo "" >> release-notes.md
              echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release-notes.md
            fi
          else
            echo "### Release v${{ steps.version.outputs.version }}" > release-notes.md
            echo "" >> release-notes.md
            echo "No changelog available." >> release-notes.md
          fi
          
          cat release-notes.md
      
      - name: Create release archive
        run: |
          mkdir -p release
          
          # Copy all script files
          cp terminal-setup.sh release/
          cp terminal-core.sh release/
          cp terminal-utils.sh release/
          cp terminal-ui.sh release/
          cp terminal-themes.sh release/
          cp terminal-assistant.sh release/
          cp install.sh release/
          
          # Copy documentation
          cp README.md release/
          cp LICENSE release/
          [ -f CHANGELOG.md ] && cp CHANGELOG.md release/
          [ -f CONTRIBUTING.md ] && cp CONTRIBUTING.md release/
          [ -f SECURITY.md ] && cp SECURITY.md release/
          
          # Create archive
          cd release
          tar -czf ../theme-after-format-v${{ steps.version.outputs.version }}.tar.gz *
          cd ..
          
          # Create zip
          cd release
          zip -r ../theme-after-format-v${{ steps.version.outputs.version }}.zip *
          cd ..
      
      - name: Generate checksums
        run: |
          sha256sum theme-after-format-v${{ steps.version.outputs.version }}.tar.gz > checksums.txt
          sha256sum theme-after-format-v${{ steps.version.outputs.version }}.zip >> checksums.txt
          cat checksums.txt
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            theme-after-format-v${{ steps.version.outputs.version }}.tar.gz
            theme-after-format-v${{ steps.version.outputs.version }}.zip
            checksums.txt
            install.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f latest
          git push -f origin latest

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: create-release
    if: always()
    
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "✅ Release completed successfully!"
          else
            echo "❌ Release failed!"
          fi